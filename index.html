<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nightfall Guild Management</title>
  <meta name="description" content="Guild management dashboard (static) - members, attendance, events, boss timers." />
  <style>
    :root{
      --bg:#0b1020;
      --text:#e7ecff;
      --muted:#a7b0d6;
      --line:rgba(255,255,255,.10);
      --accent:#6ea8fe;
      --good:#44d19d;
      --warn:#f7c948;
      --bad:#ff6b6b;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font:inherit}
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .sidebar{
      position:sticky;top:0;height:100vh;padding:22px 18px;
      border-right:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,23,48,.90), rgba(10,16,34,.60));
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:12px;padding:10px 10px 16px;margin-bottom:10px}
    .logo{
  width:60px;
  height:60px;
  background: url("https://cdn.discordapp.com/attachments/1469616315240288442/1474610413516623944/Franz_1.png?ex=699a7977&is=699927f7&hm=9b7c0a80814f61e8743de1627931f30da0619c85a2fbb55c1dfc5bbd96f4e355&") center/cover no-repeat;
  border:1px solid rgba(255,255,255,.14);
}
    .brand h1{font-size:14px;margin:0;letter-spacing:.3px;line-height:1.15}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:12px}
    .nav a{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:14px;color:var(--muted);
      border:1px solid transparent;transition:.15s ease;
    }
    .nav a:hover{background:rgba(255,255,255,.04);border-color:rgba(255,255,255,.06);color:var(--text)}
    .nav a.active{background:rgba(110,168,254,.12);border-color:rgba(110,168,254,.22);color:var(--text)}
    .pill{
      font-size:12px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--muted)
    }

    .sidebar .footer{
      position:absolute;left:18px;right:18px;bottom:18px;
      padding:14px;border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .footer .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .footer small{color:var(--muted)}

    .main{padding:24px 26px 40px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .topbar h2{margin:0;font-size:18px;letter-spacing:.2px}
    .search{
      flex:1;max-width:520px;display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
    }
    .search input{width:100%;border:0;outline:0;background:transparent;color:var(--text)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:14px;padding:10px 12px;cursor:pointer;transition:.15s ease;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18)}
    .btn.primary{background:rgba(110,168,254,.18);border-color:rgba(110,168,254,.30)}
    .btn.danger{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.25)}
    .btn.ghost{background:transparent}
    .btn.small{padding:7px 10px;border-radius:12px;font-size:13px}
    .btn[disabled]{opacity:.55;cursor:not-allowed;transform:none !important}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{
      border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 10px;border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px
    }
    .card .hd h3{margin:0;font-size:14px}
    .card .hd p{margin:4px 0 0;color:var(--muted);font-size:12px}
    .card .bd{padding:14px 16px 16px}

    .stat{display:flex;flex-direction:column;gap:6px}
    .stat .num{font-size:24px;font-weight:700;letter-spacing:.2px}
    .stat .sub{color:var(--muted);font-size:12px}
    .stat .trend{
      font-size:12px;padding:4px 8px;border-radius:999px;width:fit-content;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--muted)
    }

    .table{
      width:100%;border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.10)
    }
    .table th,.table td{
      text-align:left;padding:10px 10px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.06)
    }
    .table th{color:var(--muted);font-weight:600;background:rgba(255,255,255,.03)}
    .table tr:last-child td{border-bottom:0}

    .tag{
      display:inline-flex;align-items:center;gap:6px;padding:4px 8px;font-size:12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--muted);white-space:nowrap
    }
    .dot{width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.35)}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .form{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-top:10px}
    .field{grid-column:span 6;display:flex;flex-direction:column;gap:6px}
    .field.full{grid-column:1 / -1}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{
      padding:10px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.12);
      color:var(--text);outline:none;
    }
    input::placeholder,textarea::placeholder{color:rgba(167,176,214,.65)}

    /* Dropdown background black */
    select{ background:#000 !important; }
    select option{ background:#000; color:var(--text); }

    .rowbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:10px 0 0}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .hide{display:none !important}

    .banner{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border-radius:16px;margin:0 0 14px 0;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }

    .modalWrap{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:50
    }
    .modal{
      width:min(760px, 100%);
      border-radius:20px;border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(15,23,48,.98), rgba(10,16,34,.92));
      box-shadow:0 30px 90px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .modal .hd{padding:16px 16px 10px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .modal .bd{padding:14px 16px 16px}
    .error{color:var(--bad);font-size:13px;margin-top:8px}

    @media (max-width: 980px){
      .app{grid-template-columns:1fr}
      .sidebar{position:relative;height:auto}
      .sidebar .footer{position:relative;left:auto;right:auto;bottom:auto;margin-top:12px}
      .search{max-width:unset}
    }
    @media (max-width: 640px){
      .field{grid-column:1 / -1}
      .topbar{flex-direction:column;align-items:stretch}
      .actions{justify-content:flex-end}
      .banner{flex-direction:column;align-items:flex-start}
      .sidebar .footer .row{flex-direction:column;align-items:flex-start}
    }

    /* ===========================
       Boss Timers (NEW) ‚Äî SCOPED
       Only affects #view-boss
    =========================== */
    #view-boss .bt{
      --bg0:#050608;
      --bg1:#0a0c10;
      --text:#e8e8ea;
      --muted:#9aa0a6;

      --accentRed:#ff3b3b;
      --accentGold:#caa24a;
      --accentGold2:#f2d38a;
      --accentGreen:#34d399;

      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 14px;

      color: var(--text);
    }

    #view-boss .bt-wrap{ max-width:1600px; margin:0 auto; }
    #view-boss .bt-section{
      margin-bottom: 28px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    #view-boss .bt-toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    #view-boss .bt-input,
    #view-boss .bt-btn{
      height: 34px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 0 10px;
      outline:none;
      width: 100%;
      max-width: 100%;
    }
    #view-boss .bt-input{ min-width:150px; }
    #view-boss .bt-btn{
      cursor:pointer;
      font-weight: 600;
      letter-spacing: .2px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      background: rgba(255,255,255,.06);
    }
    #view-boss .bt-btn:hover{
      background: rgba(255,255,255,.09);
      border-color: rgba(255,255,255,.18);
    }
    #view-boss .bt-btn:active{ transform: translateY(1px) }
    #view-boss .bt-btn.bt-primary{
      background: rgba(120,170,255,.18);
      border-color: rgba(120,170,255,.35);
    }

    #view-boss .bt-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
      align-items: stretch;
    }

    #view-boss .bt-card{
      position: relative;
      border-radius: var(--radius);
      padding: 12px;
      overflow: hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      display:flex;
      flex-direction: column;
      gap: 8px;
      border: 2px solid rgba(202,162,74,.85);

      text-align:center;
      align-items:center;
    }
    #view-boss .bt-card::before{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 10px;
      border: 1px solid rgba(242,211,138,.25);
      pointer-events:none;
      opacity:.9;
    }
    #view-boss .bt-card > *{ position:relative; z-index:1; }

    #view-boss .bt-topRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      width:100%;
      margin-bottom: 2px;
    }
    #view-boss .bt-bossName{
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .7px;
      text-transform: uppercase;
      line-height: 1.1;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #view-boss .bt-pill{
      font-size: 11px;
      color: rgba(255,255,255,.85);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding: 3px 8px;
      border-radius: 999px;
      white-space:nowrap;
      user-select:none;
    }

    #view-boss .bt-timer{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-weight: 900;
      font-size: 20px;
      letter-spacing: .4px;
      margin: 0;
      width:100%;
    }
    #view-boss .bt-timer.bt-red{ color: var(--accentRed); }
    #view-boss .bt-timer.bt-green{ color: var(--accentGreen); }

    #view-boss .bt-nextLine{
      font-size: 11px;
      color: rgba(255,255,255,.8);
      margin: 0 0 6px 0;
      letter-spacing: .2px;
      width:100%;
    }
    #view-boss .bt-nextLine span{
      color: var(--accentGold2);
      font-weight: 700;
    }

    #view-boss .bt-controls{
      display:grid;
      grid-template-columns: 1fr 44px;
      gap: 8px;
      align-items:center;
      margin: 0;
      width:100%;
    }
    #view-boss .bt-dateRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      min-width: 0;
    }
    #view-boss .bt-miniBtn{
      width: 44px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(202,162,74,.55);
      background: rgba(202,162,74,.10);
      color: rgba(255,255,255,.92);
      font-weight: 800;
      letter-spacing: .2px;
      cursor:pointer;
    }
    #view-boss .bt-miniBtn:hover{
      background: rgba(202,162,74,.14);
      border-color: rgba(202,162,74,.80);
    }

    #view-boss .bt-btnStack{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 2px;
      width:100%;
    }
    #view-boss .bt-stackBtn{
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(242,211,138,.35);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.92);
      font-weight: 800;
      cursor:pointer;
      width: 100%;
    }
    #view-boss .bt-stackBtn:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(242,211,138,.55);
    }

    #view-boss .bt-footer{
      font-size: 10px;
      color: rgba(255,255,255,.55);
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap:wrap;
      padding-top: 4px;
      margin-top: 2px;
      width:100%;
    }
    #view-boss .bt-muted{ color: var(--muted); }
    #view-boss .bt-hint{
      font-size: 12px;
      color: rgba(255,255,255,.65);
      margin-top: -6px;
      margin-bottom: 10px;
    }
    #view-boss .bt-sectionTitle h2{
      font-size: 18px;
      font-weight: 900;
      margin: 0 0 10px 0;
    }

    /* Banner ‚Äî sticky inside main so it does not overlap topbar */
    #view-boss .bt-nextBossBanner{
      position: sticky;
      top: 0;
      z-index: 5;

      width: min(720px, calc(100% - 2px));
      margin: 0 auto 18px auto;

      border-radius: 999px;
      padding: 16px 18px;

      border: 1px solid rgba(242,211,138,.55);
      background:
        radial-gradient(900px 300px at 20% 20%, rgba(202,162,74,.22), transparent 60%),
        radial-gradient(700px 260px at 90% 10%, rgba(242,211,138,.18), transparent 55%),
        linear-gradient(90deg, rgba(202,162,74,.18), rgba(242,211,138,.14));
      box-shadow: 0 18px 70px rgba(0,0,0,.65);
      backdrop-filter: blur(8px);

      display:flex;
      align-items:center;
      justify-content: center;
      gap: 14px;
    }

    #view-boss .bt-nextBossTitle{
      font-size: 28px;
      font-weight: 900;
      letter-spacing: .2px;
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align:center;
    }
    #view-boss .bt-nextBossSub{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    #view-boss .bt-nbPill{
      display:flex;
      align-items:center;
      gap: 10px;
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid rgba(242,211,138,.28);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.95);
      font-weight: 900;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      letter-spacing: .2px;
      white-space: nowrap;
    }
    #view-boss .bt-nbCountdown{
      border-color: rgba(52,211,153,.45);
      background: rgba(0,0,0,.22);
      color: var(--accentGreen);
    }
    #view-boss .bt-hidden{ display:none !important; }

    @media (max-width: 420px){
      #view-boss .bt-controls{ grid-template-columns: 1fr 40px; }
      #view-boss .bt-miniBtn{ width: 40px; }
      #view-boss .bt-nextBossTitle{ font-size: 22px; }
    }
/* ===== Fix overflow inside boss cards ===== */
#view-boss .bt-card .bt-controls,
#view-boss .bt-card .bt-dateRow{
  min-width: 0 !important; /* allow grids to shrink */
}

#view-boss .bt-card .bt-input{
  min-width: 0 !important; /* OVERRIDES the 150px min-width */
  width: 100% !important;
}

#view-boss .bt-card .bt-controls{
  grid-template-columns: 1fr 36px !important; /* smaller button column */
  gap: 6px !important;
}

#view-boss .bt-card .bt-miniBtn{
  width: 36px !important;
  height: 30px !important;
}

/* If you want ZERO chance of overflow: stack date/time on small cards */
@media (max-width: 520px){
  #view-boss .bt-card .bt-dateRow{
    grid-template-columns: 1fr !important; /* date on top, time below */
  }
}

/* ===========================
   Attendance UI (NEW) ‚Äî scoped
   Only affects #view-attendance
=========================== */
/* Center BOTH label + value inside attendance cards */
#view-attendance .att-card{
  text-align: center;
}

#view-attendance .att-kicker{
  text-align: center;
  width: 100%;
}

#view-attendance .att-value{
  text-align: center;
  width: 100%;
}

/* Attendance +/- controls */
#view-attendance .att-cell{
  display:flex;
  align-items:center;
  gap:8px;
}
#view-attendance .att-cell .att-num{
  min-width: 22px;
  text-align:left;
}
#view-attendance .att-mini{
  display:inline-flex;
  gap:6px;
}
#view-attendance .att-miniBtn{
  width:26px;
  height:26px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: var(--text);
  font-weight: 900;
  cursor: pointer;
  line-height: 1;
}
#view-attendance .att-miniBtn:hover{
  border-color: rgba(255,255,255,.22);
  transform: translateY(-1px);
}
#view-attendance .att-miniBtn:active{
  transform: translateY(0px);
}

#view-attendance .att-card{
  border-radius: var(--radius2);
  background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.10);
  box-shadow: var(--shadow);
  padding:14px 16px;
  position:relative;
  overflow:hidden;
}
#view-attendance .att-card::before{
  content:"";
  position:absolute;
  left:0; top:0; right:0;
  height:3px;
  background: rgba(110,168,254,.85);
  opacity:.9;
}

#view-attendance .att-kicker{
  font-size:12px;
  color: var(--muted);
  letter-spacing:.4px;
  font-weight:700;
}
#view-attendance .att-value{
  margin-top:6px;
  font-size:22px;
  font-weight:900;
  letter-spacing:.2px;
  color: var(--text);
}

#view-attendance .att-tools{
  display:flex;
  gap:14px;
  align-items:flex-start;
  flex-wrap:wrap;
  justify-content:space-between;
}

#view-attendance .att-search{
  flex:1;
  min-width:260px;
  max-width:520px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  padding:10px 12px;
}
#view-attendance .att-search input{
  width:100%;
  border:0;
  outline:0;
  background:transparent;
  color:var(--text);
}

#view-attendance .att-admin{
  flex:1;
  min-width:320px;
  border-radius: var(--radius2);
  background: rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.10);
  padding:12px 12px 10px;
}
#view-attendance .att-adminRow{
  display:flex;
  gap:10px;
  align-items:flex-end;
  flex-wrap:wrap;
}
#view-attendance .att-adminField{
  flex:1;
  min-width:160px;
  display:flex;
  flex-direction:column;
  gap:6px;
}

#view-attendance .att-tableCard{
  border-radius: var(--radius2);
  background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.10);
  box-shadow: var(--shadow);
  overflow:hidden;
}

#view-attendance .att-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
}
#view-attendance .att-table thead th{
  text-align:left;
  padding:12px 12px;
  font-size:12px;
  color: rgba(167,176,214,.85);
  letter-spacing:.35px;
  font-weight:800;
  background: rgba(255,255,255,.03);
  border-bottom:1px solid rgba(255,255,255,.08);
  white-space:nowrap;
}
#view-attendance .att-table tbody td{
  padding:12px 12px;
  font-size:13px;
  border-bottom:1px solid rgba(255,255,255,.06);
  vertical-align:middle;
}
#view-attendance .att-table tbody tr:hover{
  background: rgba(255,255,255,.03);
}
#view-attendance .att-name{
  font-weight:900;
  color: var(--text);
}
#view-attendance .att-right{
  text-align:right;
}
#view-attendance .att-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  color: rgba(231,236,255,.92);
  font-weight:800;
}
#view-attendance .att-btn{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: var(--text);
  border-radius: 12px;
  padding:8px 10px;
  cursor:pointer;
}
#view-attendance .att-btn:hover{
  border-color: rgba(255,255,255,.20);
  transform: translateY(-1px);
}

@media (max-width: 980px){
  #view-attendance .att-cards{ grid-template-columns: 1fr; }
  #view-attendance .att-tools{ flex-direction:column; align-items:stretch; }
  #view-attendance .att-admin{ min-width:unset; }
}

  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Nightfall Guild Management</h1>
          <p class="mono"></p>
        </div>
      </div>

      <nav class="nav" id="nav">
        <a href="#dashboard" data-route="dashboard" class="active"><span>Dashboard</span><span class="pill" id="pillMembers">0</span></a>
        <a href="#boss" data-route="boss"><span>Boss</span><span class="pill" id="pillBoss">0</span></a>
        <a href="#members" data-route="members"><span>Members</span><span class="pill">Roster</span></a>
        <a href="#attendance" data-route="attendance"><span>Attendance</span><span class="pill">Boss</span></a>
        <a href="#events" data-route="events"><span>Events</span><span class="pill">Calendar</span></a>
        <a href="#settings" data-route="settings" data-admin-only="1"><span>Settings</span><span class="pill">Local</span></a>
      </nav>

      <div class="footer">
        <div class="row">
          <div>
            <small class="muted">Access</small>
            <div style="margin-top:6px;font-size:13px;">
              <span id="accessLabel" class="tag"><span class="dot warn"></span> Viewer</span>
            </div>
          </div>
          <button class="btn" id="btnExport" data-admin-only="1">Export</button>
        </div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <h2 id="pageTitle">Dashboard</h2>

        <div class="search" role="search">
          <span class="muted mono">/</span>
          <input id="globalSearch" placeholder="Search members, attendance, events‚Ä¶" autocomplete="off" />
        </div>

        <div class="actions">
          <button class="btn primary" id="btnQuickAdd" data-admin-only="1">Quick Add</button>
          <button class="btn danger" id="btnReset" data-admin-only="1">Reset</button>

          <button class="btn" id="btnAdminLogin">Admin Login</button>
          <button class="btn ghost hide" id="btnAdminLogout" data-admin-only="1">Logout</button>
        </div>
      </header>

      <div class="banner" id="viewerBanner">
        <div>
          <div style="font-weight:700;letter-spacing:.2px;">Viewer mode</div>
          <div class="muted" style="font-size:13px;margin-top:4px;">
           
          </div>
        </div>
        <button class="btn primary small" id="btnAdminLogin2">Login as Admin</button>
      </div>

      <!-- DASHBOARD -->
      <section id="view-dashboard">
        <div class="grid">
          <div class="card" style="grid-column: span 4;">
            <div class="hd">
              <div>
                <h3>Total Members</h3>
                <p>Active roster size</p>
              </div>
              <span class="tag"><span class="dot good"></span> live</span>
            </div>
            <div class="bd stat">
              <div class="num" id="statMembers">0</div>
              <div class="sub"></div>
              <div class="trend" id="trendMembers">No data yet</div>
            </div>
          </div>

          <div class="card" style="grid-column: span 4;">
            <div class="hd">
              <div>
                <h3>Boss Timers</h3>
                <p>Tracked bosses</p>
              </div>
              <span class="tag"><span class="dot warn"></span> timers</span>
            </div>
            <div class="bd stat">
              <div class="num" id="statBosses">0</div>
              <div class="sub">Manual + Scheduled</div>
              <div class="trend" id="trendBosses">Open Boss tab</div>
            </div>
          </div>

          <div class="card" style="grid-column: span 4;">
            <div class="hd">
              <div>
                <h3>Upcoming Events</h3>
                <p>Next 14 days</p>
              </div>
              <span class="tag"><span class="dot"></span> planning</span>
            </div>
            <div class="bd stat">
              <div class="num" id="statEvents">0</div>
              <div class="sub">Scheduled raids / meetings</div>
              <div class="trend" id="trendEvents">Add your first event</div>
            </div>
          </div>

          <div class="card" style="grid-column: span 8;">
            <div class="hd">
              <div>
                <h3>Roster Overview</h3>
                <p>Members List</p>
              </div>
              <span class="tag"><span class="dot good"></span> members</span>
            </div>
            <div class="bd">
              <table class="table" aria-label="Members table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Power</th>
                    <th>Status</th>
                    <th style="width:140px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="membersTableBody"></tbody>
              </table>
              <div class="rowbar">
                <div class="muted"></div>
                <a class="btn" href="#members">Open roster</a>
              </div>
            </div>
          </div>

          <div class="card" style="grid-column: span 4;">
            <div class="hd">
              <div>
                <h3>Recent Notes</h3>
                <p>Quick guild reminders</p>
              </div>
              <span class="tag"><span class="dot"></span> memo</span>
            </div>
            <div class="bd">
              <textarea id="notes" rows="10" style="width:100%;resize:vertical;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.12);color:var(--text);outline:none" placeholder="Locked (admin only)."></textarea>
              <div class="rowbar">
                <span class="muted" id="notesHint">Locked (admin only)</span>
                <button class="btn primary" id="btnSaveNotes" data-admin-only="1">Save</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- BOSS TAB (REPLACED) -->
<section id="view-boss" class="hide">
  <div class="bt">
    <div id="btNextBossBanner" class="bt-nextBossBanner bt-hidden" aria-live="polite">
      <div class="bt-nextBossCenter">
        <div class="bt-nextBossTitle">Next Boss: <span id="btNbName">‚Äî</span></div>
        <div class="bt-nextBossSub">
          <div class="bt-nbPill" title="Next spawn time (PH time)">
            üïí <strong id="btNbClock">--:-- --</strong>
          </div>
          <div class="bt-nbPill bt-nbCountdown" title="Time remaining">
            ‚è≥ <strong id="btNbCountdown">00:00:00</strong>
          </div>
        </div>
      </div>
    </div>

    <div class="bt-wrap">

      <!-- ‚úÖ Manual -->
      <div class="bt-section" id="btManualSection">
        <div class="bt-sectionTitle">
          <h2>Manual Boss Timers</h2>

          <div class="bt-toolbar" data-admin-only="1">
            <input class="bt-input" id="btManualName" placeholder="Boss Name" />
            <input class="bt-input" id="btManualHours" placeholder="Hours" type="number" step="0.01" min="0" />
            <button class="bt-btn bt-primary" id="btAddManual">Add Manual Timer</button>
            <button class="bt-btn" id="btResetAll" data-admin-only="1">Reset All (For Maintenance Only)</button>
          </div>
        </div>

        <!-- ‚úÖ SPACE BELOW TOOLBAR -->
        <div class="bt-grid" id="btManualGrid"></div>
      </div>

      <!-- ‚úÖ Scheduled -->
      <div class="bt-section" id="btScheduledSection">
        <div class="bt-sectionTitle">
          <h2>Scheduled Bosses</h2>

          <div class="bt-toolbar" data-admin-only="1">
            <input class="bt-input" id="btSchedName" placeholder="Boss Name" />
            <input class="bt-input" id="btSchedRule" placeholder="Schedule e.g. mon 12:30, tue 19:00" />
            <button class="bt-btn bt-primary" id="btAddScheduled">Add Scheduled Boss</button>
          </div>
        </div>

        <div class="bt-grid" id="btScheduledGrid"></div>
      </div>

    </div>
  </div>
</section>

      <!-- MEMBERS -->
      <section id="view-members" class="hide">
        <div class="grid">
          <div class="card" style="grid-column: span 5;" data-admin-only="1">
            <div class="hd">
              <div>
                <h3>Add Member</h3>
                <p>Admin only</p>
              </div>
              <span class="tag"><span class="dot good"></span> roster</span>
            </div>
            <div class="bd">
              <form id="memberForm" class="form">
                <div class="field">
                  <label>Name</label>
                  <input id="mName" placeholder="e.g., Raidium" required />
                </div>
                <div class="field">
                  <label>Role</label>
                  <select id="mRole">
                    <option>Guild Master</option>
                    <option>Officer</option>
                    <option>Raid Lead</option>
                    <option>Member</option>
                    <option>Recruit</option>
                  </select>
                </div>
                <div class="field">
                  <label>Power</label>
                  <input id="mPower" placeholder="e.g., 125000" inputmode="numeric" />
                </div>
                <div class="field">
                  <label>Status</label>
                  <select id="mStatus">
                    <option value="Active">Active</option>
                    <option value="Trial">Trial</option>
                    <option value="Inactive">Inactive</option>
                  </select>
                </div>
                <div class="field full">
                  <label>Notes</label>
                  <input id="mNotes" placeholder="e.g., Healer main, prefers weekends" />
                </div>
                <div class="field full" style="display:flex;flex-direction:row;gap:10px;justify-content:flex-end;">
                  <button type="button" class="btn" id="btnClearMember">Clear</button>
                  <button class="btn primary" type="submit">Save Member</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card" style="grid-column: span 7;">
            <div class="hd">
              <div>
                <h3>All Members</h3>
                <p id="membersModeHint"></p>
              </div>
              <span class="tag"><span class="dot"></span> list</span>
            </div>
            <div class="bd">
              <table class="table" aria-label="All members table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Power</th>
                    <th>Status</th>
                    <th>Notes</th>
                    <th style="width:140px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="allMembersBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- ATTENDANCE -->
<section id="view-attendance" class="hide">
  <!-- Header like the screenshot -->
  <div style="margin-bottom:14px;">
    <div style="font-size:20px;font-weight:900;letter-spacing:.2px;">Attendance</div>
    <div class="muted" style="margin-top:4px;font-size:13px;">Guild member attendance records</div>
  </div>

  <!-- Summary cards + search -->
    <div class="att-tools">
      <div class="att-search">
        <input id="attendanceSearch" placeholder="Search member name" autocomplete="off" />
      </div>

      <div class="att-admin" data-admin-only="1" style="margin-bottom:14px;">
  <div class="att-adminRow">
    <div class="att-adminField">
      <label>Total Fund (USDT)</label>
      <input id="attFundInput" type="number" step="0.01" min="0" placeholder="0" />
    </div>
    <div class="att-adminField">
      <label>Management %</label>
      <input id="attMgmtPctInput" type="number" step="1" min="0" max="100" placeholder="10" />
    </div>
    <button class="att-btn" id="attSaveFund" style="align-self:flex-end;">Save</button>
  </div>
</div>

      <!-- Admin-only: fund settings -->
      <div class="grid" style="margin-bottom:14px;">
  <div class="att-card" style="grid-column: span 4;">
    <div class="att-kicker">TOTAL FUND</div>
    <div class="att-value mono" id="attTotalFund">$0</div>
  </div>

  <div class="att-card" style="grid-column: span 4;">
    <div class="att-kicker">ATTENDANCE SHARE (<span id="attAttendPctLabel">90</span>%)</div>
    <div class="att-value mono" id="attAttendanceShare">$0</div>
  </div>

  <div class="att-card" style="grid-column: span 4;">
    <div class="att-kicker">MANAGEMENT SHARE (<span id="attMgmtPctLabel">10</span>%)</div>
    <div class="att-value mono" id="attManagementShare">$0</div>
  </div>
</div>

    <!-- Table like screenshot -->
    <div class="att-tableCard">
      <table class="att-table" aria-label="Attendance leaderboard table">
        <thead>
          <tr>
            <th style="width:220px;">NAME</th>
            <th>KRANSIA</th>
            <th>FIELD BOSS</th>
            <th>GUILD BOSS</th>
            <th>GUILD VS GUILD</th>
            <th>TOTAL POINTS</th>
            <th>PERCENTAGE</th>
            <th>USDT SHARE</th>
            <th style="width:140px;">VIEW</th>
          </tr>
        </thead>
        <tbody id="attendanceLeaderboardBody"></tbody>
      </table>
    </div>
</section>

<!-- View Details modal -->
<div class="modalWrap" id="attDetailWrap" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="attDetailTitle">
    <div class="hd">
      <div>
        <h3 id="attDetailTitle" style="margin:0;font-size:14px;">Member Details</h3>
        <p class="muted" style="margin:4px 0 0;font-size:12px;">Attendance breakdown</p>
      </div>
      <button class="btn" id="attDetailClose">Close</button>
    </div>
    <div class="bd">
      <div id="attDetailBody" class="muted" style="font-size:13px;"></div>
    </div>
  </div>
</div>

      <!-- EVENTS -->
      <section id="view-events" class="hide">
        <div class="grid">
          <div class="card" style="grid-column: span 5;" data-admin-only="1">
            <div class="hd">
              <div>
                <h3>Create Event</h3>
                <p>Admin only</p>
              </div>
              <span class="tag"><span class="dot"></span> schedule</span>
            </div>
            <div class="bd">
              <form id="eventForm" class="form">
                <div class="field">
                  <label>Title</label>
                  <input id="eTitle" placeholder="e.g., Weekly Raid" required />
                </div>
                <div class="field">
                  <label>Date</label>
                  <input id="eDate" type="date" required />
                </div>
                <div class="field">
                  <label>Time</label>
                  <input id="eTime" type="time" required />
                </div>
                <div class="field">
                  <label>Type</label>
                  <select id="eType">
                    <option value="Raid">Raid</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Tryout">Tryout</option>
                    <option value="Event">Event</option>
                  </select>
                </div>
                <div class="field full">
                  <label>Notes</label>
                  <input id="eNotes" placeholder="e.g., Min power 100k, bring pots" />
                </div>
                <div class="field full" style="display:flex;flex-direction:row;gap:10px;justify-content:flex-end;">
                  <button type="button" class="btn" id="btnClearEvent">Clear</button>
                  <button class="btn primary" type="submit">Save Event</button>
                </div>
              </form>
            </div>
          </div>

          <div class="card" style="grid-column: span 7;">
            <div class="hd">
              <div>
                <h3>Upcoming Events</h3>
                <p>Sorted by date/time</p>
              </div>
              <span class="tag"><span class="dot good"></span> next up</span>
            </div>
            <div class="bd">
              <table class="table" aria-label="Events table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Notes</th>
                    <th style="width:120px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="eventsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS (ADMIN ONLY) -->
      <section id="view-settings" class="hide" data-admin-only="1">
        <div class="grid">
          <div class="card" style="grid-column: span 7;">
            <div class="hd">
              <div>
                <h3>Data</h3>
                <p>Admin only</p>
              </div>
              <span class="tag"><span class="dot"></span> local</span>
            </div>
            <div class="bd">
              <div class="muted" style="font-size:13px;">
                Static site. Everything is saved in your browser only.
              </div>

              <div class="rowbar" style="margin-top:12px;">
                <button class="btn" id="btnExport2">Export JSON</button>
                <label class="btn" style="cursor:pointer;">
                  Import JSON
                  <input id="importFile" type="file" accept="application/json" style="display:none;">
                </label>
                <button class="btn danger" id="btnWipe">Wipe All Data</button>
              </div>

              <pre id="exportPreview" style="margin-top:12px;white-space:pre-wrap;word-break:break-word;background:rgba(0,0,0,.16);border:1px solid rgba(255,255,255,.10);padding:12px;border-radius:14px;max-height:320px;overflow:auto;"></pre>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- QUICK ADD MODAL (ADMIN ONLY) -->
  <div class="modalWrap" id="modalWrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="hd">
        <div>
          <h3 id="modalTitle" style="margin:0;font-size:14px;">Quick Add</h3>
          <p class="muted" style="margin:4px 0 0;font-size:12px;">Admin only.</p>
        </div>
        <button class="btn" id="btnCloseModal">Close</button>
      </div>
      <div class="bd">
        <form id="quickForm" class="form">
          <div class="field">
            <label>Name</label>
            <input id="qName" placeholder="Member name" required />
          </div>
          <div class="field">
            <label>Role</label>
            <select id="qRole">
              <option>Member</option>
              <option>Recruit</option>
              <option>Officer</option>
              <option>Raid Lead</option>
              <option>Guild Master</option>
            </select>
          </div>
          <div class="field">
            <label>Power</label>
            <input id="qPower" placeholder="125000" inputmode="numeric" />
          </div>
          <div class="field">
            <label>Status</label>
            <select id="qStatus">
              <option value="Active">Active</option>
              <option value="Trial">Trial</option>
              <option value="Inactive">Inactive</option>
            </select>
          </div>
          <div class="field full" style="display:flex;justify-content:flex-end;gap:10px;">
            <button type="button" class="btn" id="btnQuickCancel">Cancel</button>
            <button class="btn primary" type="submit">Add</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ADMIN LOGIN MODAL -->
  <div class="modalWrap" id="loginWrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
      <div class="hd">
        <div>
          <h3 id="loginTitle" style="margin:0;font-size:14px;">Admin Login</h3>
          <p class="muted" style="margin:4px 0 0;font-size:12px;">Unlock editing tools.</p>
        </div>
        <button class="btn" id="btnCloseLogin">Close</button>
      </div>
      <div class="bd">
        <form id="loginForm" class="form">
          <div class="field full">
            <label>Username</label>
            <input id="loginUser" autocomplete="username" placeholder="user" required />
          </div>
          <div class="field full">
            <label>Password</label>
            <input id="loginPass" type="password" autocomplete="current-password" placeholder="pass" required />
          </div>
          <div class="field full" style="display:flex;justify-content:flex-end;gap:10px;">
            <button type="button" class="btn" id="btnLoginCancel">Cancel</button>
            <button class="btn primary" type="submit">Login</button>
          </div>
          <div id="loginError" class="error hide">AH MALI BOBO!.</div>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCqClynjoUQspK89H3_-MQO7dpPMpdMuTY",
    authDomain: "nightfall-guild.firebaseapp.com",
    projectId: "nightfall-guild",
    storageBucket: "nightfall-guild.firebasestorage.app",
    messagingSenderId: "995559094027",
    appId: "1:995559094027:web:8117131f924691d48b540e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

    const appStateRef = doc(db, "guild", "nightfall"); // your main appState doc
// Boss Timers document in Firestore
const bossDocRef = doc(db, "guild", "nightfall", "bossTimers", "v1");

    window.initBossDocOnce = async () => {
  const initial = {
    manual: [
      { id: "1", name: "Baron Braudmore", hours: 32, lastKill: null, lastRestart: null },
      { id: "2", name: "Gareth", hours: 32, lastKill: null, lastRestart: null },
      // add the rest...
    ],
    scheduled: [
      { id: "s1", name: "Roderick", rule: "fri 19:00" },
      { id: "s2", name: "Milavy", rule: "sat 15:00" },
      // add the rest...
    ],
    updatedAt: Date.now()
  };

  await setDoc(bossDocRef, initial, { merge: true });
  console.log("‚úÖ Boss doc initialized");
};

// Listen for boss updates from cloud
onSnapshot(bossDocRef, (snap) => {
  if (!snap.exists()) return;
  const data = snap.data();

  // must have arrays
  if (!Array.isArray(data.manual) || !Array.isArray(data.scheduled)) return;

  // send to non-module script
  if (window.btSetFromCloud) window.btSetFromCloud(data);
  else window.__pendingBossCloud = data;
});

// Save boss state to cloud (call this when admin changes something)
window.saveBossToCloud = async (bossState) => {
  await setDoc(bossDocRef, {
    manual: bossState.manual || [],
    scheduled: bossState.scheduled || [],
    updatedAt: Date.now()
  }, { merge: true });
};
    
    

    // üî• ADD THIS RIGHT HERE
const auth = getAuth(app);

// Expose auth helpers globally so your non-module script can call them
window.authLogin = async (email, pass) => {
  await signInWithEmailAndPassword(auth, email, pass);
};

window.authLogout = async () => {
  await signOut(auth);
};

// Keep your UI gate in sync with Firebase login state
onAuthStateChanged(auth, (user) => {
  sessionStorage.setItem("l9_admin_authed_v3", user ? "1" : "0");

  // If applyAdminUI isn't ready yet, queue it.
  if (window.applyAdminUI) {
    window.applyAdminUI();
  } else {
    window.__pendingAdminApply = true;
  }

  // Also re-render once auth flips
  if (window.renderAll) {
    window.renderAll(document.getElementById("globalSearch")?.value || "");
  } else {
    window.__pendingRenderAll = true;
  }
});

  // LOAD + LIVE SYNC
  // ‚úÖ Use literal keys here because KEY/defaultState are defined later in non-module script
const APP_KEY = "nightfall_guild_state_v1";
const baseState = () => ({
  members: [],
  attendance: [],
  events: [],
  notes: "",
  bosses: [],
  fundTotal: 0,
  mgmtPct: 10,
  attPoints: {},
});

onSnapshot(appStateRef, (snap) => {
  if (!snap.exists()) return;

  const data = snap.data();

  // ‚úÖ App state from cloud (safe even if non-module script hasn't loaded yet)
 if (data.appState && typeof data.appState === "object") {
  const merged = { ...baseState(), ...data.appState };

  // ‚úÖ FIX: update BOTH window.state AND local state variable
  if (window.setStateFromCloud) {
    window.setStateFromCloud(merged);
  } else {
    window.state = merged;
  }

  localStorage.setItem(APP_KEY, JSON.stringify(merged));
}

  // ‚úÖ Boss timers from cloud
  if (data.bossState) {
    const ok =
      data.bossState &&
      Array.isArray(data.bossState.manual) &&
      Array.isArray(data.bossState.scheduled);

    if (ok) {
      let localUpdatedAt = 0;
      try {
        const localRaw = localStorage.getItem("bossTimers_v1");
        if (localRaw) localUpdatedAt = Number(JSON.parse(localRaw).updatedAt || 0);
      } catch (_) {}

      const cloudUpdatedAt = Number(data.bossState.updatedAt || 0);

      if (cloudUpdatedAt >= localUpdatedAt) {
        localStorage.setItem("bossTimers_v1", JSON.stringify(data.bossState));

        // ‚úÖ If boss script loaded, reload it. If not, queue it.
        if (window.btLoadFromStorage) window.btLoadFromStorage();
        else window.__pendingBossLoad = true;
      }
    }
  }

  // ‚úÖ Re-render if your main script is ready
  if (window.renderAll) {
    window.renderAll(document.getElementById("globalSearch")?.value || "");
  }
});

  // ‚úÖ Expose sync function globally
  window.syncToCloud = async function () {
    try {
      const payload = { appState: window.state };

      // Only send bossState if it has the right shape
      const bossRaw = localStorage.getItem("bossTimers_v1");
      if (bossRaw) {
        try {
          const bossParsed = JSON.parse(bossRaw);
          const ok =
            bossParsed &&
            Array.isArray(bossParsed.manual) &&
            Array.isArray(bossParsed.scheduled);

          if (ok) payload.bossState = bossParsed;
        } catch (_) {}
      }

      await setDoc(appStateRef, payload, { merge: true });
    } catch (err) {
      console.error("Cloud sync failed:", err);
    }
  };
</script>

  <script>
    // ---------------- Admin Auth (STATIC FRONTEND GATE) ----------------
    const ADMIN_USER = "nightfall";
    const ADMIN_PASS = "onlynightfall";
    const AUTH_KEY = "l9_admin_authed_v3"; // sessionStorage only
    const isAdmin = () => sessionStorage.getItem(AUTH_KEY) === "1";
    const setAdmin = (v) => sessionStorage.setItem(AUTH_KEY, v ? "1" : "0");

    // ---------- Storage ----------
    const KEY = "nightfall_guild_state_v1";
    const defaultState = () => ({
  members: [],
  attendance: [],
  events: [],
  notes: "",
  bosses: [],
  fundTotal: 0,
  mgmtPct: 10,

  // ‚úÖ NEW: persistent attendance points by member id
  // shape: { [memberId]: { kransia, fieldBoss, guildBoss, gvg } }
  attPoints: {},
});

    const load = () => {
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return defaultState();
        const data = JSON.parse(raw);
        return {
          members: Array.isArray(data.members) ? data.members : [],
          attendance: Array.isArray(data.attendance) ? data.attendance : [],
          events: Array.isArray(data.events) ? data.events : [],
          notes: typeof data.notes === "string" ? data.notes : "",
          bosses: Array.isArray(data.bosses) ? data.bosses : [],
          fundTotal: Number(data.fundTotal || 0),
          mgmtPct: Number(data.mgmtPct ?? 10),
          attPoints: (data.attPoints && typeof data.attPoints === "object") ? data.attPoints : {},
        };
      }catch(e){ return defaultState(); }
    };
    const save = () => {
  // keep global state in sync
  window.state = state;

  // save locally
  localStorage.setItem(KEY, JSON.stringify(window.state));

  // sync to Firebase
  if (window.syncToCloud) window.syncToCloud();
};
    // ‚úÖ INIT STATE (MISSING)
window.state = load();
let state = window.state; // optional, but keep if your code expects `state`

    window.setStateFromCloud = (merged) => {
  window.state = merged;
  state = merged; // IMPORTANT: keep local + global in sync
};

    // ---------- Helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36);
    const clamp = (n,min,max) => Math.max(min, Math.min(max, n));
    const fmtNum = (n) => { const x = Number(n); return Number.isFinite(x) ? x.toLocaleString() : ""; };
    const statusDot = (status) => status === "Active" ? "good" : status === "Trial" ? "warn" : "bad";

    function closestEl(target, selector){
  const el = (target && target.nodeType === 1) ? target : target?.parentElement;
  return el ? el.closest(selector) : null;
}

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function toast(msg){
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.bottom = "18px";
        el.style.transform = "translateX(-50%)";
        el.style.padding = "10px 12px";
        el.style.borderRadius = "14px";
        el.style.border = "1px solid rgba(255,255,255,.12)";
        el.style.background = "rgba(15,23,48,.92)";
        el.style.boxShadow = "0 14px 40px rgba(0,0,0,.55)";
        el.style.color = "var(--text)";
        el.style.fontSize = "13px";
        el.style.zIndex = "100";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = "1";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ el.style.opacity = "0"; }, 1400);
    }

    // ---------------- UI Gating ----------------
    function applyAdminUI(){
  const admin = isAdmin();

  $$("[data-admin-only='1']").forEach(el => el.classList.toggle("hide", !admin));

  const viewerBanner = $("#viewerBanner");
  if (viewerBanner) viewerBanner.classList.toggle("hide", admin);

  const btnAdminLogin = $("#btnAdminLogin");
  if (btnAdminLogin) btnAdminLogin.classList.toggle("hide", admin);

  const btnAdminLogout = $("#btnAdminLogout");
  if (btnAdminLogout) btnAdminLogout.classList.toggle("hide", !admin);

  const accessLabel = $("#accessLabel");
  if (accessLabel){
    accessLabel.innerHTML = admin
      ? `<span class="dot good"></span> Admin`
      : `<span class="dot warn"></span> Viewer`;
  }

  const notes = $("#notes");
  if (notes){
    notes.readOnly = !admin;
    notes.placeholder = admin
      ? "Example:\n‚Ä¢ Raid time: 9:00 PM\n‚Ä¢ Bring resistance pots\n‚Ä¢ New recruits interview on Friday"
      : "Locked (admin only).";
  }
      

  const notesHint = $("#notesHint");
  if (notesHint) notesHint.textContent = admin ? "Autosaves" : "Locked (admin only)";

  const membersModeHint = $("#membersModeHint");
  if (membersModeHint) membersModeHint.textContent = admin ? "Admin: edit enabled" : "Viewer: read-only";

  const attendanceModeHint = $("#attendanceModeHint");
  if (attendanceModeHint){
    attendanceModeHint.textContent = admin ? "Admin: manage logs" : "Viewer: read-only";
  }

  const r = (location.hash || "#dashboard").replace("#","");
  if(!admin && r === "settings") location.hash = "#dashboard";
}
    window.applyAdminUI = applyAdminUI;

    // If Firebase auth fired before applyAdminUI existed, apply now.
if (window.__pendingAdminApply) {
  window.__pendingAdminApply = false;
  applyAdminUI();
}

// If Firebase auth fired before renderAll existed, render now.
if (window.__pendingRenderAll) {
  window.__pendingRenderAll = false;
  renderAll(document.getElementById("globalSearch")?.value || "");
}

    // ---------- Routing ----------
    const routes = ["dashboard","boss","members","attendance","events","settings"];
    function setRoute(route){
      if(!routes.includes(route)) route = "dashboard";
      if(!isAdmin() && route === "settings"){
        route = "dashboard";
        location.hash = "#dashboard";
      }
      $("#pageTitle").textContent = route[0].toUpperCase() + route.slice(1);
      routes.forEach(r => {
        $("#view-" + r).classList.toggle("hide", r !== route);
        const a = document.querySelector(`[data-route="${r}"]`);
        if(a) a.classList.toggle("active", r === route);
      });
    }
    window.addEventListener("hashchange", () => {
      const route = (location.hash || "#dashboard").replace("#","");
      setRoute(route);
      renderAll($("#globalSearch").value || "");
      applyAdminUI();
    });

    // ---------- Members ----------
    function renderMembers(filter=""){
      const q = filter.trim().toLowerCase();
      const admin = isAdmin();

      const toPower = (v) => {
  // Handles "125000" or "125,000" or empty
  const n = Number(String(v ?? "").replace(/[^\d.]/g, ""));
  return Number.isFinite(n) ? n : 0;
};

const members = [...state.members].sort((a,b) => {
  const pa = toPower(a.power);
  const pb = toPower(b.power);

  // Highest power first
  if (pb !== pa) return pb - pa;

  // Optional tie-breakers (pick what you prefer):
  // 1) Active first (optional)
  // const sa = (a.status === "Active") ? 0 : (a.status === "Trial") ? 1 : 2;
  // const sb = (b.status === "Active") ? 0 : (b.status === "Trial") ? 1 : 2;
  // if (sa !== sb) return sa - sb;

  // 2) Name A‚ÜíZ
  return String(a.name || "").localeCompare(String(b.name || ""));
});
      const filtered = q
        ? members.filter(m =>
            (m.name||"").toLowerCase().includes(q) ||
            (m.role||"").toLowerCase().includes(q) ||
            (m.status||"").toLowerCase().includes(q) ||
            (m.notes||"").toLowerCase().includes(q)
          )
        : members;

      const dashRows = filtered.slice(0,6).map(m => `
        <tr>
          <td><strong>${escapeHtml(m.name)}</strong></td>
          <td>${escapeHtml(m.role)}</td>
          <td class="mono">${escapeHtml(fmtNum(m.power))}</td>
          <td><span class="tag"><span class="dot ${statusDot(m.status)}"></span>${escapeHtml(m.status)}</span></td>
          <td>
            <button class="btn ${admin ? "" : "ghost"}" data-edit="${m.id}" ${admin ? "" : "disabled title='Admin only'"}>Edit</button>
          </td>
        </tr>
      `).join("");

      $("#membersTableBody").innerHTML = dashRows || `<tr><td colspan="5" class="muted">No members yet.</td></tr>`;

      const allRows = filtered.map(m => `
        <tr>
          <td><strong>${escapeHtml(m.name)}</strong></td>
          <td>${escapeHtml(m.role)}</td>
          <td class="mono">${escapeHtml(fmtNum(m.power))}</td>
          <td><span class="tag"><span class="dot ${statusDot(m.status)}"></span>${escapeHtml(m.status)}</span></td>
          <td class="muted">${escapeHtml(m.notes || "")}</td>
          <td>
            ${admin
              ? `<button class="btn" data-edit="${m.id}">Edit</button>
                 <button class="btn danger" data-del="${m.id}">Del</button>`
              : `<span class="muted">‚Äî</span>`}
          </td>
        </tr>
      `).join("");

      $("#allMembersBody").innerHTML = allRows || `<tr><td colspan="6" class="muted">No roster data yet.</td></tr>`;

      $("#statMembers").textContent = String(state.members.length);
      $("#pillMembers").textContent = String(state.members.length);
      $("#trendMembers").textContent = state.members.length ? `${state.members.length} saved members` : "No data yet";
    }

    // ---------- Attendance ----------
    function money(n){
  const x = Number(n);
  if(!Number.isFinite(x)) return "$0";
  return "$" + x.toFixed(2).replace(/\.00$/, "");
}

function renderAttendanceLeaderboard(filter = "") {
  const q = String(filter || "").trim().toLowerCase();

  const totalFund = Number(state.fundTotal || 0);

  // Management % stays editable (default 10)
  const mgmtPct = clamp(Number(state.mgmtPct ?? 10), 0, 100);

  // Attendance share is remainder
  const attendPct = clamp(100 - mgmtPct, 0, 100);

  // Header labels + values
  const totalFundEl = document.getElementById("attTotalFund"); // (optional element)
  const attShareEl  = document.getElementById("attAttendanceShare");
  const mgmtShareEl = document.getElementById("attManagementShare");
  const attendPctLabel = document.getElementById("attAttendPctLabel");
  const mgmtPctLabel = document.getElementById("attMgmtPctLabel");

  if (attendPctLabel) attendPctLabel.textContent = String(attendPct);
  if (mgmtPctLabel) mgmtPctLabel.textContent = String(mgmtPct);

  const mgmtPool = totalFund * (mgmtPct / 100);
  const attendancePool = Math.max(0, totalFund - mgmtPool);

  if (totalFundEl) totalFundEl.textContent = money(totalFund); // only updates if element exists
  if (attShareEl)  attShareEl.textContent  = money(attendancePool);
  if (mgmtShareEl) mgmtShareEl.textContent = money(mgmtPool);

  // Build rows from members + saved points (attPoints)
  const rows = (state.members || []).map(m => {
    const pts = (state.attPoints && state.attPoints[m.id]) ? state.attPoints[m.id] : {};
    const kransia   = Math.max(0, Number(pts.kransia || 0));
    const fieldBoss = Math.max(0, Number(pts.fieldBoss || 0));
    const guildBoss = Math.max(0, Number(pts.guildBoss || 0));
    const gvg       = Math.max(0, Number(pts.gvg || 0));

    const total = kransia + fieldBoss + guildBoss + gvg;

    return {
      id: m.id,
      name: m.name || "(No name)",
      kransia,
      fieldBoss,
      guildBoss,
      gvg,
      total
    };
  });

  // Filter by name
  let filtered = rows;
  if (q) filtered = rows.filter(r => (r.name || "").toLowerCase().includes(q));

  // Sort highest points first
  filtered.sort((a, b) => (b.total - a.total) || String(a.name).localeCompare(String(b.name)));

  // Sum points
  const sumPoints = rows.reduce((acc, r) => acc + (r.total || 0), 0);

  const tbody = document.getElementById("attendanceLeaderboardBody");
  if (!tbody) return;

  const admin = isAdmin();

  const cellWithAdjust = (memberId, key, value) => {
    const safeId = escapeHtml(memberId);
    const safeVal = Number(value || 0);

    return admin
      ? `
        <div class="att-cell">
          <span class="mono att-num">${safeVal}</span>
          <span class="att-mini">
            <button class="att-miniBtn" data-att-adj="1" data-att-id="${safeId}" data-att-key="${key}" data-att-delta="-1" title="Minus">-</button>
            <button class="att-miniBtn" data-att-adj="1" data-att-id="${safeId}" data-att-key="${key}" data-att-delta="1" title="Plus">+</button>
          </span>
        </div>
      `
      : `<span class="mono">${safeVal}</span>`;
  };

  if (!filtered.length) {
    tbody.innerHTML = `<tr><td colspan="9" class="muted" style="padding:14px 12px;">No members found.</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(r => {
    const pct = sumPoints ? (r.total / sumPoints) * 100 : 0;
    const usdt = attendancePool * (pct / 100);

    return `
      <tr>
        <td class="att-name">${escapeHtml(r.name)}</td>

        <td>${cellWithAdjust(r.id, "kransia", r.kransia)}</td>
        <td>${cellWithAdjust(r.id, "fieldBoss", r.fieldBoss)}</td>
        <td>${cellWithAdjust(r.id, "guildBoss", r.guildBoss)}</td>
        <td>${cellWithAdjust(r.id, "gvg", r.gvg)}</td>

        <td class="mono">${r.total}</td>
        <td class="mono">${pct.toFixed(2)}%</td>
        <td class="mono">${money(usdt)}</td>
        <td>
          <button class="att-btn" data-att-view="${escapeHtml(r.id)}">View Details</button>
        </td>
      </tr>
    `;
  }).join("");
}

    // ---------- Events ----------
    function renderEvents(){
      const now = new Date();
      const in14 = new Date(now.getTime() + 14*24*60*60*1000);
      const events = [...state.events].sort((a,b) => ((a.date||"") + (a.time||"")).localeCompare((b.date||"") + (b.time||"")));
      const admin = isAdmin();

      const rows = events.map(e => `
        <tr>
          <td class="mono">${escapeHtml(e.date)}</td>
          <td class="mono">${escapeHtml(e.time)}</td>
          <td><strong>${escapeHtml(e.title)}</strong></td>
          <td><span class="tag"><span class="dot ${e.type==="Raid" ? "warn" : "good"}"></span>${escapeHtml(e.type)}</span></td>
          <td class="muted">${escapeHtml(e.notes||"")}</td>
          <td>${admin ? `<button class="btn danger" data-del-ev="${e.id}">Del</button>` : `<span class="muted">‚Äî</span>`}</td>
        </tr>
      `).join("");

      $("#eventsBody").innerHTML = rows || `<tr><td colspan="6" class="muted">No events yet.</td></tr>`;

      const upcoming14 = events.filter(e => {
        const d = new Date(e.date + "T" + (e.time || "00:00"));
        return d >= now && d <= in14;
      });

      $("#statEvents").textContent = String(upcoming14.length);
    }

    function renderNotes(){ $("#notes").value = state.notes || ""; }

    function renderExportPreview(){
      const el = $("#exportPreview");
      if(!el) return;
      const preview = {
        members: state.members.slice(0, 3),
        attendance: state.attendance.slice(0, 3),
        events: state.events.slice(0, 3),
        notes: (state.notes || "").slice(0, 120)
      };
      el.textContent = JSON.stringify(preview, null, 2);
    }

    function renderAll(filter=""){
  renderMembers(filter);

  // ‚úÖ NEW: build the member checkbox list in Attendance tab
  renderAttendanceLeaderboard(document.getElementById("attendanceSearch")?.value || "");
  renderEvents();
  renderNotes();
  renderExportPreview();
  applyAdminUI();

  if(isAdmin()){
  const fi = document.getElementById("attFundInput");
  const mi = document.getElementById("attMgmtPctInput");
  if(fi) fi.value = String(state.fundTotal || 0);
  if(mi) mi.value = String(state.mgmtPct ?? 10);
}

  // NEW boss timers stats (updates sidebar pill + dashboard)
  if(window.btUpdateStats) window.btUpdateStats();
}

    // ---------- Global Search ----------
    $("#globalSearch").addEventListener("input", () => renderAll($("#globalSearch").value || ""));

    // ---------- Admin Login ----------
const loginWrap = $("#loginWrap");

const openLogin = () => {
  $("#loginError").classList.add("hide");
  loginWrap.style.display = "flex";
  loginWrap.setAttribute("aria-hidden","false");
  $("#loginUser").value = "";
  $("#loginPass").value = "";
  $("#loginUser").focus();
};

const closeLogin = () => {
  loginWrap.style.display = "none";
  loginWrap.setAttribute("aria-hidden","true");
};

$("#btnAdminLogin").addEventListener("click", openLogin);
$("#btnAdminLogin2").addEventListener("click", openLogin);
$("#btnCloseLogin").addEventListener("click", closeLogin);
$("#btnLoginCancel").addEventListener("click", closeLogin);
loginWrap.addEventListener("click", (e)=>{ if(e.target===loginWrap) closeLogin(); });

// ‚úÖ ONE submit handler only (Firebase Auth)
$("#loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const email = $("#loginUser").value.trim();
  const pass  = $("#loginPass").value;

  try {
    await window.authLogin(email, pass);
    closeLogin();
    toast("Admin unlocked.");
    renderAll($("#globalSearch").value || "");
  } catch (err) {
    $("#loginError").classList.remove("hide");
  }
});

// ‚úÖ Logout must be async if you use await
$("#btnAdminLogout").addEventListener("click", async () => {
  try {
    await window.authLogout();
    toast("Logged out.");
    if(location.hash === "#settings") location.hash = "#dashboard";
    renderAll($("#globalSearch").value || "");
  } catch (err) {
    console.error(err);
    toast("Logout failed.");
  }
});

    // ---------- Quick Add ----------
    const modalWrap = $("#modalWrap");
    const openQuickModal = () => {
      if(!isAdmin()){ toast("Admin only."); openLogin(); return; }
      modalWrap.style.display = "flex";
      modalWrap.setAttribute("aria-hidden","false");
      $("#qName").focus();
    };
    const closeQuickModal = () => {
      modalWrap.style.display = "none";
      modalWrap.setAttribute("aria-hidden","true");
    };
    $("#btnQuickAdd").addEventListener("click", openQuickModal);
    $("#btnCloseModal").addEventListener("click", closeQuickModal);
    $("#btnQuickCancel").addEventListener("click", closeQuickModal);
    modalWrap.addEventListener("click", (e)=>{ if(e.target===modalWrap) closeQuickModal(); });

    $("#quickForm").addEventListener("submit", (e) => {
      e.preventDefault();
      if(!isAdmin()){ toast("Admin only."); return; }
      const name = $("#qName").value.trim();
      if(!name) return;
      state.members.push({
        id: uid(),
        name,
        role: $("#qRole").value,
        power: ($("#qPower").value||"").trim(),
        status: $("#qStatus").value,
        notes: "",
        createdAt: Date.now()
      });
      e.target.reset();
      closeQuickModal();
      save();
      renderAll($("#globalSearch").value || "");
      toast("Member added.");
    });

    // ---------- Member / Attendance / Event admin actions ----------
    let editingMemberId = null;

    $("#memberForm")?.addEventListener("submit", (e) => {
      e.preventDefault();
      if(!isAdmin()){ toast("Admin only."); return; }
      const member = {
        id: editingMemberId || uid(),
        name: $("#mName").value.trim(),
        role: $("#mRole").value,
        power: ($("#mPower").value || "").trim(),
        status: $("#mStatus").value,
        notes: $("#mNotes").value.trim(),
        createdAt: editingMemberId
          ? (state.members.find(m=>m.id===editingMemberId)?.createdAt || Date.now())
          : Date.now()
      };
      if(!member.name) return;

      const idx = state.members.findIndex(m => m.id === member.id);
      if(idx >= 0) state.members[idx] = member;
      else state.members.push(member);

      editingMemberId = null;
      e.target.reset();
      $("#mRole").value = "Guild Master";
      $("#mStatus").value = "Active";

      save();
      renderAll($("#globalSearch").value || "");
      toast("Member saved.");
    });

    $("#btnClearMember")?.addEventListener("click", () => {
      if(!isAdmin()){ toast("Admin only."); return; }
      editingMemberId = null;
      $("#memberForm").reset();
      $("#mRole").value = "Guild Master";
      $("#mStatus").value = "Active";
    });

    $("#attendanceForm")?.addEventListener("submit", (e) => {
  e.preventDefault();
  if(!isAdmin()){ toast("Admin only."); return; }

  const boss = $("#aBoss").value.trim();
  const date = $("#aDate").value;
  const attended = Number($("#aAttended").value || 0);
  const total = Number($("#aTotal").value || Math.max(1, state.members.length || 1));
  if(!boss || !date) return;

  // ‚úÖ NEW: collect checked member IDs
  const selectedIds = Array.from(document.querySelectorAll('input[name="aMembers"]:checked'))
    .map(cb => cb.value);

  state.attendance.push({
    id: uid(),
    boss,
    date,
    members: selectedIds, // ‚úÖ NEW: saved into the log
    attended: Math.max(0, attended),
    total: Math.max(1, total),
    ts: Date.now()
  });

  e.target.reset();
  $("#aDate").value = date;

  save();
  renderAll($("#globalSearch").value || "");
  toast("Attendance logged.");
});

    $("#btnClearAttendance")?.addEventListener("click", () => {
      if(!isAdmin()){ toast("Admin only."); return; }
      $("#attendanceForm").reset();
    });

    $("#eventForm")?.addEventListener("submit", (e) => {
      e.preventDefault();
      if(!isAdmin()){ toast("Admin only."); return; }
      const title = $("#eTitle").value.trim();
      const date = $("#eDate").value;
      const time = $("#eTime").value;
      const type = $("#eType").value;
      const notes = $("#eNotes").value.trim();
      if(!title || !date || !time) return;

      state.events.push({ id: uid(), title, date, time, type, notes, ts: Date.now() });
      e.target.reset();
      save();
      renderAll($("#globalSearch").value || "");
      toast("Event saved.");
    });

    $("#btnClearEvent")?.addEventListener("click", () => {
      if(!isAdmin()){ toast("Admin only."); return; }
      $("#eventForm").reset();
    });

    $("#btnSaveNotes").addEventListener("click", () => {
      if(!isAdmin()){ toast("Admin only."); return; }
      state.notes = $("#notes").value || "";
      save();
      toast("Notes saved.");
    });

    $("#notes").addEventListener("input", () => {
      if(!isAdmin()) return;
      state.notes = $("#notes").value || "";
      save();
    });

   // ---------- Table clicks (ONE global listener) ----------
document.addEventListener("click", (e) => {
  const t = e.target;

  // ‚úÖ Attendance +/- controls
  const adjBtn = closestEl(e.target, "[data-att-adj='1']");
  if (adjBtn) {
    if (!isAdmin()) {
      toast("Admin only.");
      openLogin();
      return;
    }

    const id = adjBtn.getAttribute("data-att-id");
    const key = adjBtn.getAttribute("data-att-key"); // kransia | fieldBoss | guildBoss | gvg
    const delta = Number(adjBtn.getAttribute("data-att-delta") || 0);

    if (!id || !key || !Number.isFinite(delta)) return;

    if (!state.attPoints || typeof state.attPoints !== "object") state.attPoints = {};
    if (!state.attPoints[id]) state.attPoints[id] = { kransia: 0, fieldBoss: 0, guildBoss: 0, gvg: 0 };

    const cur = Number(state.attPoints[id][key] || 0);
    const next = Math.max(0, cur + delta); // never below 0
    state.attPoints[id][key] = next;

    save();
    renderAttendanceLeaderboard(document.getElementById("attendanceSearch")?.value || "");
    return; // ‚õî stop here so other click actions don't also fire
  }

  // Member edit/delete + logs/events delete
  const editId = t?.dataset?.edit;
  const delId = t?.dataset?.del;
  const delAtt = t?.dataset?.delAtt;
  const delEv = t?.dataset?.delEv;

  if (editId) {
    if (!isAdmin()) { toast("Admin only."); openLogin(); return; }
    const m = state.members.find(x => x.id === editId);
    if (!m) return;

    location.hash = "#members";
    editingMemberId = m.id;
    $("#mName").value = m.name || "";
    $("#mRole").value = m.role || "Member";
    $("#mPower").value = m.power || "";
    $("#mStatus").value = m.status || "Active";
    $("#mNotes").value = m.notes || "";
    toast("Editing member‚Ä¶");
  }

  if (delId) {
    if (!isAdmin()) { toast("Admin only."); return; }
    state.members = state.members.filter(m => m.id !== delId);
    save(); renderAll($("#globalSearch").value || "");
    toast("Member deleted.");
  }

  if (delAtt) {
    if (!isAdmin()) { toast("Admin only."); return; }
    state.attendance = state.attendance.filter(a => a.id !== delAtt);
    save(); renderAll($("#globalSearch").value || "");
    toast("Log deleted.");
  }

  if (delEv) {
    if (!isAdmin()) { toast("Admin only."); return; }
    state.events = state.events.filter(ev => ev.id !== delEv);
    save(); renderAll($("#globalSearch").value || "");
    toast("Event deleted.");
  }
});

    // ---------- Reset (ADMIN ONLY) ----------
    $("#btnReset").addEventListener("click", () => {
      if(!isAdmin()){ toast("Admin only."); openLogin(); return; }
      $("#globalSearch").value = "";
      renderAll("");
      toast("View reset.");
    });

    // ---------- Export / Import (ADMIN ONLY) ----------
    const exportJson = () => {
      if(!isAdmin()){ toast("Admin only."); openLogin(); return; }
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "l9-guild-data.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported JSON.");
    };
    $("#btnExport").addEventListener("click", exportJson);
    $("#btnExport2")?.addEventListener("click", exportJson);

    $("#btnWipe")?.addEventListener("click", () => {
      if(!isAdmin()){ toast("Admin only."); openLogin(); return; }
      if(!confirm("Wipe ALL local data?")) return;
      state = defaultState();
      save();
      renderAll("");
      toast("All data wiped.");
    });

    $("#importFile")?.addEventListener("change", async (e) => {
      if(!isAdmin()){ toast("Admin only."); openLogin(); e.target.value=""; return; }
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        state = {
          members: Array.isArray(data.members) ? data.members : [],
          attendance: Array.isArray(data.attendance) ? data.attendance : [],
          events: Array.isArray(data.events) ? data.events : [],
          notes: typeof data.notes === "string" ? data.notes : "",
          bosses: Array.isArray(data.bosses) ? data.bosses : [],
          fundTotal: Number(data.fundTotal || 0),
          mgmtPct: Number(data.mgmtPct ?? 10),
          attPoints: (data.attPoints && typeof data.attPoints === "object") ? data.attPoints : {},
        };
        save();
        renderAll($("#globalSearch").value || "");
        toast("Imported JSON.");
      }catch(err){
        alert("Import failed: invalid JSON");
      }finally{
        e.target.value = "";
      }
    });

    // ---------- Init ----------
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    if($("#aDate")) $("#aDate").value = `${yyyy}-${mm}-${dd}`;
    if($("#eDate")) $("#eDate").value = `${yyyy}-${mm}-${dd}`;

    const route = (location.hash || "#dashboard").replace("#","");
    setRoute(route);
    renderAll("");

    // Attendance search
document.getElementById("attendanceSearch")?.addEventListener("input", (e) => {
  renderAttendanceLeaderboard(e.target.value || "");
});

// Admin: save fund settings
document.getElementById("attSaveFund")?.addEventListener("click", () => {
  if(!isAdmin()){ toast("Admin only."); openLogin(); return; }

  const fund = Number(document.getElementById("attFundInput")?.value || 0);
  const mgmt = Number(document.getElementById("attMgmtPctInput")?.value ?? 10);

  state.fundTotal = Math.max(0, fund);
  state.mgmtPct = clamp(mgmt, 0, 100);

  save();
  toast("Fund settings saved.");
  renderAttendanceLeaderboard(document.getElementById("attendanceSearch")?.value || "");
});

// Details modal
const attWrap = document.getElementById("attDetailWrap");
const attClose = () => {
  attWrap.style.display = "none";
  attWrap.setAttribute("aria-hidden","true");
};
document.getElementById("attDetailClose")?.addEventListener("click", attClose);
attWrap?.addEventListener("click", (e)=>{ if(e.target===attWrap) attClose(); });

// Table click: View Details
document.addEventListener("click", (e) => {
  const btn = closestEl(e.target, "[data-att-view]");
  if(!btn) return;

  const id = btn.getAttribute("data-att-view");
  const member = state.members.find(m => m.id === id);
  const name = member?.name || "(Unknown)";

  // Simple details: list logs where this member is included
  const logs = (state.attendance || [])
    .filter(l => Array.isArray(l.members) && l.members.includes(id))
    .sort((a,b) => (b.ts||0) - (a.ts||0))
    .slice(0, 30);

  const body = document.getElementById("attDetailBody");
  const title = document.getElementById("attDetailTitle");

  if(title) title.textContent = `${name} ‚Äî Details`;

  if(!logs.length){
    body.innerHTML = `<div class="muted">No attendance records yet.</div>`;
  } else {
    body.innerHTML = `
      <div style="margin-bottom:10px;">
        <span class="tag"><span class="dot good"></span> ${logs.length} logs</span>
      </div>
      <table class="table" style="border-radius:14px;">
        <thead>
          <tr>
            <th>Date</th>
            <th>Boss</th>
          </tr>
        </thead>
        <tbody>
          ${logs.map(l => `
            <tr>
              <td class="mono">${escapeHtml(l.date || "")}</td>
              <td>${escapeHtml(l.boss || "")}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  attWrap.style.display = "flex";
  attWrap.setAttribute("aria-hidden","false");
});

    /* =========================================================
       Boss Timers (NEW) ‚Äî embedded inside Boss tab
       Namespaced to avoid collisions
    ========================================================= */
    (function(){
      const PH_TZ = "Asia/Manila";

      const phClockFmt = new Intl.DateTimeFormat("en-US", {
        timeZone: PH_TZ, hour: "2-digit", minute: "2-digit", hour12: true
      });
      const phShortFmt = new Intl.DateTimeFormat("en-US", {
        timeZone: PH_TZ,
        year: "numeric", month: "numeric", day: "numeric",
        hour: "numeric", minute: "2-digit", second: "2-digit",
        hour12: true
      });

      const formatClockPH = (dt) => phClockFmt.format(dt);
      const formatShortPH = (dt) => phShortFmt.format(dt);

      function phParts(dt){
  const parts = new Intl.DateTimeFormat("en-CA", {
    timeZone: PH_TZ,
    year: "numeric", month: "2-digit", day: "2-digit",
    hour: "2-digit", minute: "2-digit",
    hour12: false
  }).formatToParts(dt);

  const get = (t) => parts.find(p => p.type === t)?.value || "";
  const yyyy = get("year");
  const mm = get("month");
  const dd = get("day");
  const hh = get("hour");
  const mi = get("minute");

  return { date: `${yyyy}-${mm}-${dd}`, time: `${hh}:${mi}` };
}

// ‚úÖ Interpret user input as PH time no matter what device timezone is
function dateFromPHInput(dateVal, timeVal){
  // Accept "HH:MM" or "HH:MM:SS" and force PH (+08:00)
  if(!dateVal || !timeVal) return new Date(NaN);

  const parts = String(timeVal).trim().split(":");
  const hh = parts[0]?.padStart(2,"0");
  const mm = parts[1]?.padStart(2,"0");
  if(hh == null || mm == null) return new Date(NaN);

  return new Date(`${dateVal}T${hh}:${mm}:00+08:00`);
}

      const LS_KEY = "bossTimers_v1";

      const DEFAULT_MANUAL = [
        { name:"Baron Braudmore", hours: 32, lastKill: null, lastRestart: "2026-01-13T17:45:01" },
        { name:"Gareth", hours: 32, lastKill: null, lastRestart: "2026-01-13T17:45:52" },
        { name:"Lady Dalia", hours: 18, lastKill: null, lastRestart: null },
        { name:"Ego", hours: 21, lastKill: null, lastRestart: "2026-01-13T17:35:09" },
        { name:"Livera", hours: 24, lastKill: null, lastRestart: null },
        { name:"Araneo", hours: 24, lastKill: null, lastRestart: null },
        { name:"Undomiel", hours: 24, lastKill: null, lastRestart: null },
        { name:"Amentis", hours: 29, lastKill: null, lastRestart: "2026-01-13T17:44:17" },
        { name:"General Aquleus", hours: 29, lastKill: null, lastRestart: "2026-01-13T17:44:35" },
        { name:"Larba", hours: 35, lastKill: null, lastRestart: "2026-01-13T17:50:28" },
        { name:"Shuliar", hours: 35, lastKill: null, lastRestart: "2026-01-13T17:50:41" },
        { name:"Catena", hours: 35, lastKill: null, lastRestart: "2026-01-13T17:51:06" },
        { name:"Venatus", hours: 10, lastKill: null, lastRestart: "2026-01-13T19:34:08" },
        { name:"Viorent", hours: 10, lastKill: null, lastRestart: "2026-01-13T19:34:24" },
        { name:"Titore", hours: 37, lastKill: null, lastRestart: "2026-01-13T17:42:46" },
        { name:"Duplican", hours: 48, lastKill: null, lastRestart: "2026-01-13T17:46:57" },
        { name:"Metus", hours: 48, lastKill: null, lastRestart: "2026-01-13T17:47:15" },
        { name:"Wannitas", hours: 48, lastKill: null, lastRestart: "2026-01-13T17:47:29" },
        { name:"Secreta", hours: 62, lastKill: null, lastRestart: "2026-01-13T18:47:49" },
        { name:"Ordo", hours: 62, lastKill: null, lastRestart: "2026-01-13T18:47:53" },
        { name:"Asta", hours: 62, lastKill: null, lastRestart: "2026-01-13T18:48:00" },
        { name:"Supore", hours: 62, lastKill: null, lastRestart: "2026-02-20T01:57:18" }
      ];

      const DEFAULT_SCHEDULED = [
        { name:"Roderick", rule:"fri 19:00" },
        { name:"Milavy", rule:"sat 15:00" },
        { name:"Ringor", rule:"sat 17:00" },
        { name:"Saphirus", rule:"sun 17:00, tue 17:00" },
        { name:"Auraq", rule:"sun 21:00, wed 21:00" },
        { name:"Climantis", rule:"mon 11:30, thu 11:30" },
        { name:"Thymele", rule:"mon 19:00, wed 19:00" },
        { name:"Neutro", rule:"tue 19:00, thu 19:00" }
      ];

      function uid2(){
  if (window.crypto?.randomUUID) return crypto.randomUUID();
  return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

function dedupeIds(arr){
  const seen = new Set();
  return arr.map(x => {
    let id = x?.id;
    if(!id || seen.has(id)){
      id = uid2();
      return { ...x, id };
    }
    seen.add(id);
    return x;
  });
}

function ensureIds(arr){
  return dedupeIds((arr || []).map(x => (x && x.id) ? x : ({ ...x, id: uid2() })));
}

      function normalizeManual(manualArr){
        const defaultByName = new Map(DEFAULT_MANUAL.map(d => [d.name.toLowerCase(), d.hours]));
        return ensureIds(manualArr).map(b => {
          let h = Number(b.hours);
          if(!Number.isFinite(h) || h <= 0){
            const fallback = defaultByName.get(String(b.name || "").toLowerCase());
            if(Number.isFinite(fallback)) h = fallback;
          }
          if(!Number.isFinite(h) || h <= 0) h = 24;
          return { ...b, hours: h };
        });
      }

      function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){
      return { manual: normalizeManual(DEFAULT_MANUAL), scheduled: ensureIds(DEFAULT_SCHEDULED), updatedAt: 0 };
    }
    const parsed = JSON.parse(raw);
    const manualRaw = Array.isArray(parsed.manual) ? parsed.manual : DEFAULT_MANUAL;
    const scheduledRaw = Array.isArray(parsed.scheduled) ? parsed.scheduled : DEFAULT_SCHEDULED;

    return {
      manual: normalizeManual(manualRaw),
      scheduled: ensureIds(scheduledRaw),
      updatedAt: Number(parsed.updatedAt || 0)
    };
  }catch{
    return { manual: normalizeManual(DEFAULT_MANUAL), scheduled: ensureIds(DEFAULT_SCHEDULED), updatedAt: 0 };
  }
}
      let btState = loadState();

      window.btSetFromCloud = (cloud) => {
  const manualRaw = Array.isArray(cloud?.manual) ? cloud.manual : [];
  const schedRaw  = Array.isArray(cloud?.scheduled) ? cloud.scheduled : [];

  btState = {
    manual: normalizeManual(ensureIds(manualRaw)),
    scheduled: ensureIds(schedRaw),
    updatedAt: Number(cloud?.updatedAt || 0)
  };

  // Keep local cache aligned (prevents bouncing back)
  localStorage.setItem(LS_KEY, JSON.stringify(btState));

  btRenderAll();
};


const saveState = async () => {
  btState.updatedAt = Date.now();

  // keep local cache
  localStorage.setItem(LS_KEY, JSON.stringify(btState));

  // push to firebase
  if (window.saveBossToCloud) {
    try { await window.saveBossToCloud(btState); } catch(e){ console.error(e); }
  }

  // keep appState syncing too (optional)
  if (window.syncToCloud) window.syncToCloud();
};

      if (!localStorage.getItem(LS_KEY)) {
  saveState();
}
      
      
      // Hard repair hours for defaults (keeps kill times)
      (function edgeRepairHours(){
        const defaultByName = new Map(DEFAULT_MANUAL.map(d => [d.name.toLowerCase(), d.hours]));
        let changed = false;
        btState.manual = btState.manual.map(b => {
          const def = defaultByName.get(String(b.name || "").toLowerCase());
          if(Number.isFinite(def) && b.hours !== def){
            changed = true;
            return { ...b, hours: def };
          }
          const coerced = Number(b.hours);
          if(Number.isFinite(coerced) && coerced !== b.hours){
            changed = true;
            return { ...b, hours: coerced };
          }
          return b;
        });
        if(changed) saveState();
      })();

      // Date helpers
      const DOW = { sun:0, mon:1, tue:2, wed:3, thu:4, fri:5, sat:6 };
      const pad2 = (n) => String(n).padStart(2,"0");
      function msToClock(ms){
  const neg = ms < 0;
  ms = Math.abs(ms);

  const sec = Math.floor(ms / 1000);
  const hours = Math.floor(sec / 3600);             // ‚úÖ total hours (no days)
  const mins  = Math.floor((sec % 3600) / 60);
  const secs  = sec % 60;

  const out = `${hours}:${pad2(mins)}:${pad2(secs)}`;
  return neg ? `-${out}` : out;
}

      function parseScheduleRule(ruleStr){
        const parts = ruleStr.split(",").map(s => s.trim()).filter(Boolean);
        const out = [];
        for(const p of parts){
          const m = p.match(/^([a-z]{3})\s+(\d{1,2}):(\d{2})$/i);
          if(!m) continue;
          const dowKey = m[1].toLowerCase();
          if(!(dowKey in DOW)) continue;
          const hour = Math.max(0, Math.min(23, parseInt(m[2],10)));
          const min = Math.max(0, Math.min(59, parseInt(m[3],10)));
          out.push({ dow: DOW[dowKey], hour, min });
        }
        return out;
      }

      function nextOccurrenceFromRule(ruleStr, fromDate = new Date()){
  const rules = parseScheduleRule(ruleStr);
  if(rules.length === 0) return null;

  // ‚úÖ Get PH time "now"
  const nowPH = new Date(
    new Intl.DateTimeFormat("en-US", {
      timeZone: "Asia/Manila",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    }).format(fromDate).replace(",", "")
  );

  let best = null;

  for(const r of rules){
    const candidate = new Date(nowPH);

    candidate.setSeconds(0,0);
    candidate.setHours(r.hour, r.min, 0, 0);

    const curDow = nowPH.getDay();
    let addDays = (r.dow - curDow + 7) % 7;

    if(addDays === 0 && candidate <= nowPH) addDays = 7;

    candidate.setDate(candidate.getDate() + addDays);

    if(!best || candidate < best) best = candidate;
  }

  return best;
}

      // Manual logic
      const findManualIndexById = (id) => btState.manual.findIndex(b => b.id === id);
      const findScheduledIndexById = (id) => btState.scheduled.findIndex(b => b.id === id);

      function getManualNextTime(b){
  if(!b?.lastKill) return null;

  const hours = Number(b.hours);
  if(!Number.isFinite(hours) || hours <= 0) return null;

  const kill = new Date(b.lastKill);
  if(Number.isNaN(kill.getTime())) return null;

  return new Date(kill.getTime() + (hours * 3600 * 1000));
}

      function getManualDiffMs(b, now){
        const next = getManualNextTime(b);
        if(!next) return Number.POSITIVE_INFINITY;
        return next - now;
      }
      function getScheduledDiffMs(b, now){
        const next = nextOccurrenceFromRule(b.rule, now);
        if(!next) return Number.POSITIVE_INFINITY;
        return next - now;
      }

      // Auto-reset manual when expired (after 30s)
      const pendingAutoResets = new Map();
      function scheduleAutoResetIfExpired(manualBoss, diffMs){
        if(!manualBoss?.id) return;
        if(!manualBoss.lastKill) return;

        if(diffMs <= 0){
          if(pendingAutoResets.has(manualBoss.id)) return;

          const t = setTimeout(() => {
            pendingAutoResets.delete(manualBoss.id);
            const idx = findManualIndexById(manualBoss.id);
            if(idx < 0) return;

            const b = btState.manual[idx];
            const next = getManualNextTime(b);
            const stillExpired = next ? (next - new Date()) <= 0 : false;

            if(stillExpired){
              const now = new Date();
              btState.manual[idx].lastKill = now.toISOString();
              btState.manual[idx].lastRestart = now.toISOString();
              saveState();
              btRenderAll();
            }
          }, 30000);

          pendingAutoResets.set(manualBoss.id, t);
        } else {
          const t = pendingAutoResets.get(manualBoss.id);
          if(t){
            clearTimeout(t);
            pendingAutoResets.delete(manualBoss.id);
          }
        }
      }

      function resetAllManualTimers(){
        const now = new Date().toISOString();
        btState.manual = btState.manual.map(b => ({ ...b, lastKill: now, lastRestart: now }));

        for(const t of pendingAutoResets.values()) clearTimeout(t);
        pendingAutoResets.clear();

        saveState();
        btRenderAll();
      }

      // DOM refs (Boss tab)
      const bannerEl = document.getElementById("btNextBossBanner");
      const nbNameEl = document.getElementById("btNbName");
      const nbClockEl = document.getElementById("btNbClock");
      const nbCountdownEl = document.getElementById("btNbCountdown");

      const manualGrid = document.getElementById("btManualGrid");
      const scheduledGrid = document.getElementById("btScheduledGrid");

      function escapeHtml2(str){
        return String(str ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      function escapeAttr2(str){ return escapeHtml2(str).replaceAll("\n"," "); }

      function updateNextBossBanner(now){
        let best = null;

        for(const b of btState.manual){
          const next = getManualNextTime(b);
          if(!next) continue;
          const diff = next - now;
          if(diff <= 0) continue;
          if(!best || diff < best.diffMs) best = { name: b.name, nextDate: next, diffMs: diff };
        }
        for(const b of btState.scheduled){
          const next = nextOccurrenceFromRule(b.rule, now);
          if(!next) continue;
          const diff = next - now;
          if(diff <= 0) continue;
          if(!best || diff < best.diffMs) best = { name: b.name, nextDate: next, diffMs: diff };
        }

        if(!best){
          bannerEl.classList.add("bt-hidden");
          return;
        }

        bannerEl.classList.remove("bt-hidden");
        nbNameEl.textContent = best.name;
        nbClockEl.textContent = formatClockPH(best.nextDate);
        nbCountdownEl.textContent = msToClock(best.diffMs);
      }

      // Stats updater used by main app
      window.btUpdateStats = function(){
        const total = (btState.manual?.length || 0) + (btState.scheduled?.length || 0);
        const pillBoss = document.getElementById("pillBoss");
        const statBosses = document.getElementById("statBosses");
        const trendBosses = document.getElementById("trendBosses");

        if(pillBoss) pillBoss.textContent = String(total);
        if(statBosses) statBosses.textContent = String(total);
        if(trendBosses){
          trendBosses.textContent = total
            ? `${btState.manual.length} manual ‚Ä¢ ${btState.scheduled.length} scheduled`
            : "Add bosses";
        }
      };

      window.btLoadFromStorage = function(){
  btState = loadState();
  btRenderAll();
};
      // ‚úÖ If Firestore snapshot arrived before boss script loaded
if (window.__pendingBossLoad) {
  window.__pendingBossLoad = false;
  window.btLoadFromStorage();
}

      // Render
      function btRenderAll(){
        btRenderManual();
        btRenderScheduled();
        window.btUpdateStats && window.btUpdateStats();
      }

      function btRenderManual(){
        if(!manualGrid) return;
        manualGrid.innerHTML = "";
        const now = new Date();

        const ordered = btState.manual
          .map(b => ({ b, diff: getManualDiffMs(b, now) }))
          .sort((a, c) => (a.diff - c.diff) || a.b.name.localeCompare(c.b.name));

        ordered.forEach(({ b }) => {
          const next = getManualNextTime(b);
          const nextTxt = next ? formatClockPH(next) : "--:-- --";
          const id = b.id;

          const card = document.createElement("div");
          card.className = "bt-card bt-manual";

          card.innerHTML = `
  <div class="bt-topRow">
    <div class="bt-bossName">${escapeHtml2(b.name)}</div>
    <div class="bt-pill" data-admin-only="1">${escapeHtml2(String(b.hours))}h</div>
  </div>

  <div class="bt-timer bt-red" data-bt-manual-timer="${escapeAttr2(id)}">00:00:00</div>
  <div class="bt-nextLine">NEXT: <span data-bt-manual-next="${escapeAttr2(id)}">${escapeHtml2(nextTxt)}</span></div>

  <div data-admin-only="1">
    <div class="bt-controls">
      <div class="bt-dateRow">
        <input class="bt-input" id="bt_mk_date_${escapeAttr2(id)}" type="date" />
        <input class="bt-input" id="bt_mk_time_${escapeAttr2(id)}" type="time" />
      </div>
      <button class="bt-miniBtn" data-action="fillKill" data-id="${escapeAttr2(id)}" title="Fill with now">üïí</button>
    </div>

    <div class="bt-controls">
      <div class="bt-dateRow">
        <input class="bt-input" id="bt_mn_date_${escapeAttr2(id)}" type="date" />
        <input class="bt-input" id="bt_mn_time_${escapeAttr2(id)}" type="time" />
      </div>
      <button class="bt-miniBtn" data-action="fillNext" data-id="${escapeAttr2(id)}" title="Fill with next">‚è±</button>
    </div>

    <div class="bt-btnStack">
      <button type="button" class="bt-stackBtn" data-action="killedNow" data-id="${escapeAttr2(id)}">Killed Now</button>
      <button type="button" class="bt-stackBtn" data-action="setKill" data-id="${escapeAttr2(id)}">Set Kill</button>
      <button type="button" class="bt-stackBtn" data-action="setNext" data-id="${escapeAttr2(id)}">Set Next</button>
    </div>

    <div class="bt-footer">
      <div>Last restart: ${b.lastRestart ? escapeHtml2(formatShortPH(new Date(b.lastRestart))) : "--"}</div>
      <div class="bt-muted">${b.lastKill ? "Kill set" : "No kill yet"}</div>
    </div>
  </div>
`;

          card.addEventListener("click", (e) => {
            const btn = closestEl(e.target, "[data-action]");
            if(!btn) return;

            const action = btn.dataset.action;
            const bossId = btn.dataset.id;

            const manualKilledNow = (id2) => {
  const idx = findManualIndexById(id2);
  if(idx < 0) return;

  // Force numeric hours (fix "does not reset hours" problem)
  const h = Number(btState.manual[idx].hours);
  btState.manual[idx].hours = (Number.isFinite(h) && h > 0) ? h : 24;

  const now2 = new Date();
  btState.manual[idx].lastKill = now2.toISOString();
  btState.manual[idx].lastRestart = now2.toISOString();

  // clear pending autoreset if any (prevents weird bounce)
  const t = pendingAutoResets.get(id2);
  if(t){ clearTimeout(t); pendingAutoResets.delete(id2); }

  saveState();
  btRenderAll();
};

const manualSetKill = (id2) => {
  const idx = findManualIndexById(id2);
  if(idx < 0) return;

  const dateEl = document.getElementById(`bt_mk_date_${id2}`);
  const timeEl = document.getElementById(`bt_mk_time_${id2}`);
  const dateVal = dateEl?.value;
  const timeVal = timeEl?.value;
  if(!dateVal || !timeVal){
    window.toast?.("Pick a kill date + time first.");
    return;
  }

  // Force numeric hours
  const h = Number(btState.manual[idx].hours);
  btState.manual[idx].hours = (Number.isFinite(h) && h > 0) ? h : 24;

  const dt = dateFromPHInput(dateVal, timeVal);
  if(Number.isNaN(dt.getTime())){
    window.toast?.("Invalid kill date/time.");
    return;
  }

  btState.manual[idx].lastKill = dt.toISOString();
  btState.manual[idx].lastRestart = new Date().toISOString();

  const t = pendingAutoResets.get(id2);
  if(t){ clearTimeout(t); pendingAutoResets.delete(id2); }

  saveState();
  btRenderAll();
};

const manualSetNext = (id2) => {
  const idx = findManualIndexById(id2);
  if(idx < 0) return;

  const dateEl = document.getElementById(`bt_mn_date_${id2}`);
  const timeEl = document.getElementById(`bt_mn_time_${id2}`);
  const dateVal = dateEl?.value;
  const timeVal = timeEl?.value;
  if(!dateVal || !timeVal){
    window.toast?.("Pick a next date + time first.");
    return;
  }

  // Force numeric hours
  const hours = Number(btState.manual[idx].hours);
  btState.manual[idx].hours = (Number.isFinite(hours) && hours > 0) ? hours : 24;

  const next2 = dateFromPHInput(dateVal, timeVal);
  if(Number.isNaN(next2.getTime())){
    window.toast?.("Invalid next date/time.");
    return;
  }

  // kill = next - hours
  const killMs = next2.getTime() - (btState.manual[idx].hours * 3600 * 1000);
  const killDt = new Date(killMs);
  if(Number.isNaN(killDt.getTime())){
    window.toast?.("Could not compute kill time from next time.");
    return;
  }

  btState.manual[idx].lastKill = killDt.toISOString();
  btState.manual[idx].lastRestart = new Date().toISOString();

  const t = pendingAutoResets.get(id2);
  if(t){ clearTimeout(t); pendingAutoResets.delete(id2); }

  saveState();
  btRenderAll();
};

            if(action === "killedNow") manualKilledNow(bossId);
            if(action === "setKill") manualSetKill(bossId);
            if(action === "setNext") manualSetNext(bossId);

            if(action === "fillKill"){
  const now2 = new Date();
  const { date, time } = phParts(now2);

  const d = document.getElementById(`bt_mk_date_${bossId}`);
  const t = document.getElementById(`bt_mk_time_${bossId}`);
  if(d) d.value = date;
  if(t) t.value = time;
}

            if(action === "fillNext"){
  const idx = findManualIndexById(bossId);
  const nxt = (idx >= 0)
    ? (getManualNextTime(btState.manual[idx]) || new Date())
    : new Date();

  const { date, time } = phParts(nxt);

  const d = document.getElementById(`bt_mn_date_${bossId}`);
  const t = document.getElementById(`bt_mn_time_${bossId}`);
  if(d) d.value = date;
  if(t) t.value = time;
}
          });

          manualGrid.appendChild(card);
        });
      }

      function btRenderScheduled(){
        if(!scheduledGrid) return;
        scheduledGrid.innerHTML = "";
        const now = new Date();

        const ordered = btState.scheduled
          .map(b => ({ b, diff: getScheduledDiffMs(b, now) }))
          .sort((a, c) => (a.diff - c.diff) || a.b.name.localeCompare(c.b.name));

        ordered.forEach(({ b }) => {
          const next = nextOccurrenceFromRule(b.rule, new Date());
          const nextTxt = next ? formatClockPH(next) : "--:-- --";
          const id = b.id;

          const card = document.createElement("div");
          card.className = "bt-card bt-scheduled";

          card.innerHTML = `
  <div class="bt-topRow">
    <div class="bt-bossName">${escapeHtml2(b.name)}</div>
    <div class="bt-pill" data-admin-only="1">Scheduled</div>
  </div>

  <div class="bt-timer bt-red" data-bt-sched-timer="${escapeAttr2(id)}">00:00:00</div>
  <div class="bt-nextLine">NEXT: <span data-bt-sched-next="${escapeAttr2(id)}">${escapeHtml2(nextTxt)}</span></div>

  <div data-admin-only="1">
    <div class="bt-controls">
      <input class="bt-input" id="bt_sr_${escapeAttr2(id)}" value="${escapeAttr2(b.rule)}" />
      <button class="bt-miniBtn" data-action="saveRule" data-id="${escapeAttr2(id)}">Save</button>
    </div>

    <div class="bt-btnStack">
      <button class="bt-stackBtn" data-action="setNextNow" data-id="${escapeAttr2(id)}">Set Next</button>
    </div>

    <div class="bt-footer">
      <div>Schedule: ${escapeHtml2(b.rule)}</div>
      <div class="bt-muted">PH time</div>
    </div>
  </div>
`;

          card.addEventListener("click", (e) => {
            const btn = closestEl(e.target, "[data-action]");
            if(!btn) return;

            const action = btn.dataset.action;
            const bossId = btn.dataset.id;
            const idx = findScheduledIndexById(bossId);
            if(idx < 0) return;

            if(action === "saveRule"){
              const inp = document.getElementById(`bt_sr_${bossId}`);
              const val = inp?.value.trim();
              if(!val) return;
              btState.scheduled[idx].rule = val;
              saveState();
              btRenderAll();
            }

            if(action === "setNextNow"){
              const now2 = new Date();
              now2.setSeconds(0,0);
              now2.setMinutes(now2.getMinutes() + 5);
              const dowKey = Object.keys(DOW).find(k => DOW[k] === now2.getDay()) || "mon";
              const hh = pad2(now2.getHours());
              const mm = pad2(now2.getMinutes());
              btState.scheduled[idx].rule = `${dowKey} ${hh}:${mm}`;
              saveState();
              btRenderAll();
            }
          });

          scheduledGrid.appendChild(card);
        });
      }

      // Live ticking
      function setTimerColor(el, diffMs){
        el.classList.remove("bt-green","bt-red");
        el.classList.add(diffMs > 0 ? "bt-green" : "bt-red");
      }

      function btTick(){
        const now = new Date();
        updateNextBossBanner(now);

        document.querySelectorAll("[data-bt-manual-timer]").forEach(el => {
          const id = el.getAttribute("data-bt-manual-timer");
          const idx = findManualIndexById(id);
          if(idx < 0) return;

          const b = btState.manual[idx];
          const next = getManualNextTime(b);

          if(!next){
            el.textContent = "--:--:--";
            setTimerColor(el, -1);
            return;
          }

          const diff = next - now;
          el.textContent = msToClock(diff);
          setTimerColor(el, diff);
          scheduleAutoResetIfExpired(b, diff);
        });

        document.querySelectorAll("[data-bt-manual-next]").forEach(el => {
          const id = el.getAttribute("data-bt-manual-next");
          const idx = findManualIndexById(id);
          if(idx < 0) return;
          const next = getManualNextTime(btState.manual[idx]);
          el.textContent = next ? formatClockPH(next) : "--:-- --";
        });

        document.querySelectorAll("[data-bt-sched-timer]").forEach(el => {
          const id = el.getAttribute("data-bt-sched-timer");
          const idx = findScheduledIndexById(id);
          if(idx < 0) return;

          const b = btState.scheduled[idx];
          const next = nextOccurrenceFromRule(b.rule, now);

          if(!next){
            el.textContent = "00:00:00";
            setTimerColor(el, -1);
            return;
          }

          const diff = next - now;
          el.textContent = msToClock(diff);
          setTimerColor(el, diff);
        });

        document.querySelectorAll("[data-bt-sched-next]").forEach(el => {
          const id = el.getAttribute("data-bt-sched-next");
          const idx = findScheduledIndexById(id);
          if(idx < 0) return;
          const next = nextOccurrenceFromRule(btState.scheduled[idx].rule, now);
          el.textContent = next ? formatClockPH(next) : "--:-- --";
        });
      }

      // Buttons
      document.getElementById("btAddManual")?.addEventListener("click", () => {
        const name = document.getElementById("btManualName").value.trim();
        const hoursStr = document.getElementById("btManualHours").value.trim();
        const hours = Number(hoursStr);
        if(!name || !Number.isFinite(hours) || hours <= 0) return;

        btState.manual.unshift({ id: uid2(), name, hours, lastKill: null, lastRestart: new Date().toISOString() });
        document.getElementById("btManualName").value = "";
        document.getElementById("btManualHours").value = "";
        saveState();
        btRenderAll();
      });

      document.getElementById("btAddScheduled")?.addEventListener("click", () => {
        const name = document.getElementById("btSchedName").value.trim();
        const rule = document.getElementById("btSchedRule").value.trim();
        if(!name || !rule) return;

        btState.scheduled.unshift({ id: uid2(), name, rule });
        document.getElementById("btSchedName").value = "";
        document.getElementById("btSchedRule").value = "";
        saveState();
        btRenderAll();
      });

      document.getElementById("btResetAll")?.addEventListener("click", () => {
        if(confirm("Restart ALL Manual Boss Timers now?")){
          resetAllManualTimers();
        }
      });

      // Boot
      btRenderAll();
      btTick();
      setInterval(btTick, 250);
    })();
  </script>
</body>
</html>
